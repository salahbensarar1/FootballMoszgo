name: Flutter CI/CD Pipeline

on:
  push:
    branches: [main]
    paths:
      - 'lib/**'           # App code changes
      - 'android/**'       # Android config
      - 'ios/**'           # iOS config  
      - 'pubspec.yaml'     # Dependencies
      - 'pubspec.lock'     # Dependency versions
      - 'test/**'          # Test files
      - '!**.md'           # Skip markdown files
      - '!docs/**'         # Skip documentation
      
  pull_request:
    branches: [main]
    paths:
      - 'lib/**'
      - 'android/**'
      - 'ios/**'
      - 'pubspec.yaml'
      - 'test/**'
      - '!**.md'
      - '!docs/**'
      
  workflow_dispatch:        # Manual trigger

env:
  FLUTTER_VERSION: 'latest'  # Centralized version management

jobs:
  # ðŸ” Code Quality & Testing
  analyze-and-test:
    name: Code Analysis & Testing
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ðŸŽ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
          
      - name: ðŸ“¦ Cache Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: flutter-deps-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            flutter-deps-${{ runner.os }}-
            
      - name: ðŸ”§ Install Dependencies
        run: flutter pub get
        
      - name: ðŸ” Run Flutter Analyze
        run: flutter analyze --fatal-infos
        
      - name: ðŸ§ª Check for Tests
        id: check_tests
        run: |
          if [ -d "test" ] && [ "$(find test -name "*.dart" | wc -l)" -gt 0 ]; then
            echo "has_tests=true" >> $GITHUB_OUTPUT
            echo "âœ… Found test files"
          else
            echo "has_tests=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ No test files found"
          fi
          
      - name: ðŸ§ª Run Tests
        if: steps.check_tests.outputs.has_tests == 'true'
        run: |
          flutter test --coverage --reporter=expanded
          echo "âœ… Tests completed"
        continue-on-error: false
        
      - name: ðŸ“Š Upload Coverage
        if: steps.check_tests.outputs.has_tests == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 7

  # ðŸ¤– Android Build
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    needs: analyze-and-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: â˜• Setup Java 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          
      - name: ðŸŽ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
          
      - name: ðŸ“¦ Cache Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: flutter-deps-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}-${{ hashFiles('**/gradle-wrapper.properties') }}
          restore-keys: |
            flutter-deps-${{ runner.os }}-
            
      - name: ðŸ”§ Install Dependencies
        run: flutter pub get
        
      - name: ðŸ—ï¸ Build Android APK
        run: |
          echo "ðŸ—ï¸ Building release APK..."
          flutter build apk --release --shrink
          echo "âœ… APK build completed"
          
      - name: ðŸ“± Upload to Firebase App Distribution
        if: success()
        uses: wzieba/Firebase-Distribution-Github-Action@v1
        with:
          appId: ${{ secrets.FIREBASE_APP_ID_ANDROID }}
          serviceCredentialsFileContent: ${{ secrets.FIREBASE_CREDENTIALS }}
          groups: testers
          file: build/app/outputs/flutter-apk/app-release.apk
          releaseNotes: |
            ðŸš€ New build from commit: ${{ github.sha }}
            ðŸ“ Changes: ${{ github.event.head_commit.message }}
            
      - name: ðŸ“¦ Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-${{ github.sha }}
          path: build/app/outputs/flutter-apk/app-release.apk
          retention-days: 7

  # ðŸŽ iOS Build (Manual Only - Cost Optimization)
  build-ios:
    name: Build iOS App
    runs-on: macos-latest
    needs: analyze-and-test
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: ðŸ’° Cost Warning
        run: |
          echo "âš ï¸ iOS builds cost ~10x more than Android builds"
          echo "ðŸ’¡ This workflow only runs on manual trigger"
          
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        
      - name: ðŸŽ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true
          
      - name: ðŸ“¦ Cache iOS Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.pub-cache
            ios/Pods
            ios/.symlinks
          key: ios-deps-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}-${{ hashFiles('**/Podfile.lock') }}
          restore-keys: |
            ios-deps-${{ runner.os }}-
            
      - name: ðŸ”§ Install Flutter Dependencies
        run: flutter pub get
        
      - name: ðŸŽ Install CocoaPods
        run: |
          cd ios
          pod install --repo-update
          
      - name: ðŸ—ï¸ Build iOS App
        run: |
          echo "ðŸ—ï¸ Building iOS app (no code signing)..."
          flutter build ios --release --no-codesign
          echo "âœ… iOS build completed"
          
      - name: ðŸ“¦ Upload iOS Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-app-${{ github.sha }}
          path: build/ios/iphoneos/
          retention-days: 7

  # ðŸ“Š Build Summary
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [analyze-and-test, build-android]
    if: always()
    
    steps:
      - name: ðŸ“‹ Generate Summary
        run: |
          echo "## ðŸš€ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Code Analysis | ${{ needs.analyze-and-test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Android Build | ${{ needs.build-android.result == 'success' && 'âœ… Passed' || needs.build-android.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“± Deployment" >> $GITHUB_STEP_SUMMARY
          echo "- **Firebase App Distribution**: ${{ needs.build-android.result == 'success' && 'APK uploaded to testers group' || 'Not deployed' }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifacts**: Available for 7 days" >> $GITHUB_STEP_SUMMARY