name: Build iOS App (Manual Only)
on:
  # ğŸ’° MANUAL ONLY - iOS builds are 10x more expensive!
  workflow_dispatch:
    inputs:
      deploy_to_firebase:
        description: 'Deploy to Firebase App Distribution?'
        required: false
        default: false
        type: boolean
  # ğŸ¯ Only on releases or critical changes
  push:
    branches: [ main ]
    paths:
      - 'ios/**'          # Only iOS-specific changes
      - 'pubspec.yaml'    # Only dependency changes
    # Don't run on every code change!

jobs:
  # ğŸš¨ Add a cost warning
  cost-warning:
    runs-on: ubuntu-latest
    steps:
      - name: Cost Warning
        run: |
          echo "âš ï¸  iOS builds cost ~$1.20 per run (10x more than Android)"
          echo "ğŸ’¡ Only run this workflow when you really need iOS builds"
          echo "ğŸ¯ Consider using manual trigger (workflow_dispatch) for testing"
          
  build_ios:
    runs-on: macos-latest
    needs: cost-warning
    # ğŸ›¡ï¸ Only run on manual trigger or iOS-specific changes
    if: |
      github.event_name == 'workflow_dispatch' || 
      (github.event_name == 'push' && 
       (contains(github.event.head_commit.modified, 'ios/') || 
        contains(github.event.head_commit.modified, 'pubspec.yaml')))
    steps:
    - name: â¬‡ï¸ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ’» Set up Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.27.1'
        cache: true
        
    # ğŸš€ Cache CocoaPods and Flutter deps
    - name: Cache iOS Dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.pub-cache
          ios/Pods
          ios/.symlinks
        key: ios-deps-${{ runner.os }}-${{ hashFiles('**/pubspec.lock') }}-${{ hashFiles('**/Podfile.lock') }}
        restore-keys: |
          ios-deps-${{ runner.os }}-
          
    - name: ğŸ“¦ Install Flutter dependencies
      run: flutter pub get
      
    - name: ğŸ Install CocoaPods dependencies
      run: |
        cd ios
        pod install --repo-update
        
    - name: ğŸ§ª Build iOS app (no code signing)
      run: |
        flutter build ios --release --no-codesign
        
    - name: ğŸ“ Upload .app artifact
      uses: actions/upload-artifact@v4
      with:
        name: ios-app-${{ github.sha }}
        path: build/ios/iphoneos/
        retention-days: 7  # Shorter retention for iOS artifacts
        
    # ğŸ”’ Only deploy if manually requested
    - name: ğŸš€ Upload to Firebase App Distribution
      if: github.event.inputs.deploy_to_firebase == 'true'
      run: |
        echo "Firebase deployment would happen here"
        echo "Currently disabled - needs Apple Developer account"

